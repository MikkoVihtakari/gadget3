---
title: "Writing G3 Actions"
output:
  html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Writing G3 Actions}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, message=FALSE, echo=FALSE}
library(gadget3)
library(magrittr)
```

## g3 Functions

There are also special g3 functions that can be used in formula that affect the
resulting code, rather than just being called when run.

See ``?g3_param`` for more information.

## Stock steps

Most actions interact with stocks, and fill out abstract formulae with the
stocks provided to the function. To do this you need to do a series of
substitutions, which are handled by ``g3_step()``. This takes a formula,
looks for ``stock_*`` named functions and mangles the formula as appropriate.
For example, a snippet from ``action_mature.R``.

```{r, eval=FALSE}
    out <- new.env(parent = emptyenv())
    out[[step_id(run_at, 1, stock)]] <- g3_step(f_substitute(~{
        stock_comment("g3a_mature for ", stock)
        # Matured stock will weigh the same
        stock_with(stock, stock_with(matured, matured__wgt <- stock__wgt))

        stock_iterate(stock, stock_intersect(matured, if (run_f) {
            stock_comment("Move matured ", stock, " into temporary storage")
            stock_ss(matured__num) <- stock_ss(stock__num) * maturity_f
            stock_ss(stock__num) <- stock_ss(stock__num) - stock_ss(matured__num)
        }))
    }, list(run_f = run_f, maturity_f = maturity_f)))
```

Assume that ``stock`` has name "ling_imm" and ``matured`` has name "ling_imm_maturing".

The first line uses ``stock_comment()`` to produce a ``comment()`` function
call, ``comment("g3a_mature for ling_imm")``.

Next ``stock_with()`` is used to to transform ``matured__wgt <- stock__wgt``
to use the proper stock names. We don't care about dimensions since we're
copying over all the data.

Finally, we use a combination of ``stock_iterate()`` and ``stock_intersect()``.
``stock_iterate()`` will create a loop that loops over all of the stock's
dimensions, and ``stock_ss()`` will subset ``stock__num``, prividing
1-dimension lengthgroup vector.  ``stock_intersect()``.

These iterators will then be available to the ``maturity_f`` that the users
provide, as demonstrated in the [Stocks] section.
