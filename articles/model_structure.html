<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Structure of a gadget3 model • gadget3</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Structure of a gadget3 model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gadget3</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model_structure.html">Structure of a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/tmb-gotchas.html">Gotchas and quirks of TMB</a>
    </li>
    <li>
      <a href="../articles/writing_actions.html">Writing G3 Actions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Structure of a gadget3 model</h1>
            
      
      
      <div class="hidden name"><code>model_structure.Rmd</code></div>

    </div>

    
    
<p>The following describes the structure of a gadget3 model, from the bottom up.</p>
<div id="r-formula-or-the-tilde-operator" class="section level2">
<h2 class="hasAnchor">
<a href="#r-formula-or-the-tilde-operator" class="anchor"></a>R formula, or the tilde operator</h2>
<p>Crucial to gadget3 is the <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/formula.html">R formula</a>, created using the tilde operator (<code>~</code>). These get used in several places in R for various things, but at their core the tilde operator stores the R code on the left and right hand sides, as well as the environment it was created in, which amounts to all variables defined at the time.</p>
<p>For example, let’s declare a function that produces a formula, and make some:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">get_formula &lt;-<span class="st"> </span><span class="cf">function</span> (size) {</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="co"># NB: The reason we make a function here is so we have an isolated environment</span></a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="co"># to make examples cleaner.</span></a>
<a class="sourceLine" id="cb1-4" title="4">    cows &lt;-<span class="st"> </span>size <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-5" title="5">    pigs &lt;-<span class="st"> </span>size <span class="op">*</span><span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="op">~</span>cows <span class="op">+</span><span class="st"> </span>pigs)</a>
<a class="sourceLine" id="cb1-7" title="7">}</a>
<a class="sourceLine" id="cb1-8" title="8">f &lt;-<span class="st"> </span><span class="kw">get_formula</span>(<span class="dv">8</span>)</a>
<a class="sourceLine" id="cb1-9" title="9">g &lt;-<span class="st"> </span><span class="kw">get_formula</span>(<span class="dv">5</span>)</a></code></pre></div>
<p><code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> shows <code>f</code> contains the formula’s code (not the result of cows + pigs), and has an environment attached:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(f)</a></code></pre></div>
<pre><code>## Class 'formula'  language ~cows + pigs
##   ..- attr(*, ".Environment")=&lt;environment: 0xnnnnnnnnnnnn&gt;</code></pre>
<p>We can look into this environment, and see the values that got set for cows &amp; pigs:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(f)))</a></code></pre></div>
<pre><code>## List of 3
##  $ pigs: num 32
##  $ cows: num 16
##  $ size: num 8</code></pre>
<p>We can do similarly for <code>g</code>, and see the results are different:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(g)))</a></code></pre></div>
<pre><code>## List of 3
##  $ pigs: num 20
##  $ cows: num 10
##  $ size: num 5</code></pre>
<p>Note that:</p>
<ul>
<li>R hasn’t at any point worked out <code>cows + pigs</code>, the code was stored for later use.</li>
<li>The environment (i.e. all variables defined at that point) is “remembered”</li>
</ul>
<p>A g3 model at it’s core is a list of formula objects that make up the model. We can even use Gadget3 to compile our simple example above into an R function:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="../reference/run_r.html">g3_to_r</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(f))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     cows &lt;- 16
##     pigs &lt;- 32
##     while (TRUE) {
##         cows + pigs
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"
## attr(,"parameter_template")
## list()</code></pre>
<p>…or a TMB template:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw"><a href="../reference/run_tmb.html">g3_to_tmb</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(f))</a></code></pre></div>
<pre><code>## #include &lt;TMB.hpp&gt;
## template&lt;class Type&gt;
## Type objective_function&lt;Type&gt;::operator() () {
##     
##     Type cows = 16;
##     Type pigs = 32;
## 
##     while (true) {
##         cows + pigs;
##     }
##     abort();  // Should have returned somewhere in the loop
## }</code></pre>
<p>Obviously this in itself isn’t a very useful function, but you can see that the environment for the formula has provided the initial values for the variables, and the code itself has been put into the main loop.</p>
<p>Also note that, despite appearances, we’re not generically converting R into C++. There’s a subset of R that gadget3 understands and knows how to convert. Using R libraries isn’t possible, for example. To simplify scoping rules, we assume variables are either global, and should have different names, or are iterators in loops, in which case they will be local to that loop.</p>
</div>
<div id="actions" class="section level2">
<h2 class="hasAnchor">
<a href="#actions" class="anchor"></a>Actions</h2>
<p>In reality you will never be providing formulae to insert into models directly, you’d be using the g3 action functions to generate these for you. All action functions, prefixed with <code>g3a_</code>, produce a list of formula objects—an action in gadget3 parlance. These are where the gadget functionality is implemented.</p>
<p>One of the simplest is <code>g3a_time</code>, which produces code that will count years/steps, and stop when the end of the time period is reached. For example:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw"><a href="../reference/action_time.html">g3a_time</a></span>(<span class="dv">1990</span>, <span class="dv">1999</span>)</a></code></pre></div>
<pre><code>## $`000`
## ~{
##     debug_label("g3a_time")
##     cur_time &lt;- cur_time + 1
##     if (cur_time &gt; total_steps) 
##         return(nll)
##     cur_year &lt;- start_year + (cur_time%/%step_count)
##     cur_step &lt;- (cur_time%%step_count) + 1
##     cur_step_size &lt;- step_lengths[[cur_step]]/as.numeric(12)
##     cur_step_final &lt;- cur_step == step_count
##     if (trace_mode) 
##         Rprintf("** Tick: %d-%d\n", cur_year, cur_step)
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;</code></pre>
<p>Like in the example above, the definitions are part of the formula’s environment, and if we compile it we see our years ending up in the code.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw"><a href="../reference/run_r.html">g3_to_r</a></span>(<span class="kw"><a href="../reference/action_time.html">g3a_time</a></span>(<span class="dv">1990</span>, <span class="dv">1999</span>))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     Rprintf &lt;- function (...) 
##     {
##         cat(sprintf(...))
##     }
##     cur_time &lt;- -1L
##     step_lengths &lt;- structure(12L, .Dim = 1L)
##     end_year &lt;- 1999L
##     start_year &lt;- 1990L
##     total_steps &lt;- length(step_lengths) * (end_year - start_year) + 
##         length(step_lengths) - 1
##     nll &lt;- 0
##     cur_year &lt;- 0L
##     step_count &lt;- 1L
##     cur_step &lt;- 0L
##     cur_step_size &lt;- 0
##     cur_step_final &lt;- FALSE
##     while (TRUE) {
##         {
##             comment("g3a_time")
##             cur_time &lt;- cur_time + 1
##             if (cur_time &gt; total_steps) 
##                 return(nll)
##             cur_year &lt;- start_year + (cur_time%/%step_count)
##             cur_step &lt;- (cur_time%%step_count) + 1
##             cur_step_size &lt;- step_lengths[[cur_step]]/as.numeric(12)
##             cur_step_final &lt;- cur_step == step_count
##             if (FALSE) 
##                 Rprintf("** Tick: %d-%d\n", cur_year, cur_step)
##         }
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"
## attr(,"parameter_template")
## list()</code></pre>
<p>In this case our years have been hard-coded, but their definitions could themselves be formula and the end result will be added to the model. For example:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw"><a href="../reference/run_r.html">g3_to_r</a></span>(<span class="kw"><a href="../reference/action_time.html">g3a_time</a></span>(<span class="dv">1990</span>, <span class="op">~</span>start_year <span class="op">+</span><span class="st"> </span><span class="dv">4</span> ))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     Rprintf &lt;- function (...) 
##     {
##         cat(sprintf(...))
##     }
##     cur_time &lt;- -1L
##     step_lengths &lt;- structure(12L, .Dim = 1L)
##     start_year &lt;- 1990L
##     end_year &lt;- start_year + 4
##     total_steps &lt;- length(step_lengths) * (end_year - start_year) + 
##         length(step_lengths) - 1
##     nll &lt;- 0
##     cur_year &lt;- 0L
##     step_count &lt;- 1L
##     cur_step &lt;- 0L
##     cur_step_size &lt;- 0
##     cur_step_final &lt;- FALSE
##     while (TRUE) {
##         {
##             comment("g3a_time")
##             cur_time &lt;- cur_time + 1
##             if (cur_time &gt; total_steps) 
##                 return(nll)
##             cur_year &lt;- start_year + (cur_time%/%step_count)
##             cur_step &lt;- (cur_time%%step_count) + 1
##             cur_step_size &lt;- step_lengths[[cur_step]]/as.numeric(12)
##             cur_step_final &lt;- cur_step == step_count
##             if (FALSE) 
##                 Rprintf("** Tick: %d-%d\n", cur_year, cur_step)
##         }
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"
## attr(,"parameter_template")
## list()</code></pre>
<p>TODO: This example rapidly runs out of steam since we don’t substitute the formula’s environment into the output expression. Fix it or stop suggesting it.</p>
</div>
<div id="stocks" class="section level2">
<h2 class="hasAnchor">
<a href="#stocks" class="anchor"></a>Stocks</h2>
<p>Beyond <code><a href="../reference/action_time.html">g3a_time()</a></code>, pretty much any action will be describing changes to a stock, possibly via. interacting with another stock (or fleet). To keep track of this state, we use <em>g3_stock</em> objects. These describe several things:</p>
<ul>
<li>The dimensions one would use if making an array to store data on that stock. For example if we want an array for number of individuals, what lengthgroups do we use? How many ages do we store? How many (and which) areas do we have?</li>
<li>What code do we need to iterate over the stock? Say I want to add 1 individual to each lengthgroup, how do I loop over all the other dimensions?</li>
<li>If looping over one stock, how do I find corresponding entries in another stock? For example, my fleet is only interested in prey that is in the same area.</li>
</ul>
<p>g3_stock objects can be created with either <code><a href="../reference/stock.html">g3_stock()</a></code> or <code><a href="../reference/stock.html">g3_fleet()</a></code>, the former will store lengthgroups, which fleets do not have.</p>
<p>Actions will store data about the stocks, for instance the current number of individuals, in arrays called stock instances. We can see what sort of arrays a stock will make by using <code>gadget3:::stock_instance</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">ling_imm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stock.html">g3_stock</a></span>(<span class="st">'ling_imm'</span>, <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb18-2" title="2">gadget3<span class="op">:::</span><span class="kw">stock_instance</span>(ling_imm)</a></code></pre></div>
<pre><code>## length
##  len0 len10 len20 len30 len40 len50 
##    NA    NA    NA    NA    NA    NA</code></pre>
<p>To add complexity to our model, we can use other <code>g3s_</code> functions, such as <code><a href="../reference/stock_areas.html">g3s_livesonareas()</a></code> or <code><a href="../reference/stock_age.html">g3s_age()</a></code>, which adds area or age dimensions to a stock:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">ling_imm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stock.html">g3_stock</a></span>(<span class="st">'ling_imm'</span>, <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">10</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">    </span><span class="kw"><a href="../reference/stock_age.html">g3s_age</a></span>(<span class="dv">3</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb20-3" title="3">gadget3<span class="op">:::</span><span class="kw">stock_instance</span>(ling_imm)</a></code></pre></div>
<pre><code>##        age
## length  age3 age4 age5 age6 age7 age8 age9 age10
##   len0    NA   NA   NA   NA   NA   NA   NA    NA
##   len10   NA   NA   NA   NA   NA   NA   NA    NA
##   len20   NA   NA   NA   NA   NA   NA   NA    NA
##   len30   NA   NA   NA   NA   NA   NA   NA    NA
##   len40   NA   NA   NA   NA   NA   NA   NA    NA
##   len50   NA   NA   NA   NA   NA   NA   NA    NA</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">ling_imm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stock.html">g3_stock</a></span>(<span class="st">'ling_imm'</span>, <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">10</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">    </span><span class="kw"><a href="../reference/stock_areas.html">g3s_livesonareas</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">    </span><span class="kw"><a href="../reference/stock_age.html">g3s_age</a></span>(<span class="dv">3</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb22-4" title="4">gadget3<span class="op">:::</span><span class="kw">stock_instance</span>(ling_imm)[,,<span class="st">'age3'</span>]</a></code></pre></div>
<pre><code>##        area
## length  area1 area2
##   len0     NA    NA
##   len10    NA    NA
##   len20    NA    NA
##   len30    NA    NA
##   len40    NA    NA
##   len50    NA    NA</code></pre>
<p>When you use an action such as <code><a href="../reference/action_grow.html">g3a_growmature()</a></code>, you provide g3_stock(s) to act on, and formula objects to fill in gaps in the code. <code><a href="../reference/action_grow.html">g3a_growmature()</a></code> will iterate over all areas/ages the stock has, and apply growth for each length group it finds.</p>
<p><code><a href="../reference/action_grow.html">g3a_growmature()</a></code> itself doesn’t care about areas or age, it just does the same to each. However, the formula you supply can. <code>age</code> and <code>area</code> variables will be set with the current age/area, which you can use when writing formula. For example:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">fn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_r.html">g3_to_r</a></span>(<span class="kw"><a href="../reference/action_grow.html">g3a_growmature</a></span>(</a>
<a class="sourceLine" id="cb24-2" title="2">    ling_imm,</a>
<a class="sourceLine" id="cb24-3" title="3">    <span class="dt">impl_f =</span> <span class="kw"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span>(</a>
<a class="sourceLine" id="cb24-4" title="4">        <span class="dt">delta_len_f =</span> <span class="op">~</span>age <span class="op">*</span><span class="st"> </span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb24-5" title="5">        <span class="dt">delta_wgt_f =</span> <span class="op">~</span>area <span class="op">*</span><span class="st"> </span><span class="dv">20</span>,</a>
<a class="sourceLine" id="cb24-6" title="6">        <span class="dt">beta_f =</span> <span class="op">~</span><span class="kw"><a href="../reference/language.html">g3_param</a></span>(<span class="st">"ling.bbin"</span>),</a>
<a class="sourceLine" id="cb24-7" title="7">        <span class="dt">maxlengthgroupgrowth =</span> <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb24-8" title="8">    <span class="dt">transition_f =</span> <span class="op">~</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb24-9" title="9">fn</a></code></pre></div>
<pre><code>## function (param) 
## {
##     growth_bbinom &lt;- function (dmu, lengthgrouplen, binn, beta) 
##     {
##         delt_l &lt;- dmu/lengthgrouplen
##         alpha &lt;- (beta * delt_l)/(binn - delt_l)
##         x &lt;- 0:binn
##         na &lt;- length(alpha)
##         n &lt;- length(x) - 1
##         alpha &lt;- rep(alpha, n + 1)
##         x &lt;- rep(x, each = na)
##         val &lt;- exp(lgamma(n + 1) + lgamma(alpha + beta) + lgamma(n - 
##             x + beta) + lgamma(x + alpha) - lgamma(n - x + 1) - 
##             lgamma(x + 1) - lgamma(n + alpha + beta) - lgamma(beta) - 
##             lgamma(alpha))
##         dim(val) &lt;- c(na, n + 1)
##         return(val)
##     }
##     g3a_grow_apply &lt;- function (delta_l, delta_w, input_num, 
##         input_wgt) 
##     {
##         na &lt;- dim(delta_l)[[1]]
##         n &lt;- dim(delta_l)[[2]] - 1
##         logspace_add_vec &lt;- function(a, b) {
##             pmax(a, b) + log1p(exp(pmin(a, b) - pmax(a, b)))
##         }
##         growth.matrix &lt;- array(0, c(na, na))
##         wgt.matrix &lt;- array(0, c(na, na))
##         for (lg in 1:na) {
##             if (lg == na) {
##                 growth.matrix[na, na] &lt;- 1
##                 wgt.matrix[lg, na] &lt;- 0
##             }
##             else if (lg + n &gt; na) {
##                 growth.matrix[lg, lg:(na - 1)] &lt;- delta_l[lg, 
##                   1:(na - lg)]
##                 growth.matrix[lg, na] &lt;- sum(delta_l[lg, (na - 
##                   lg + 1):(n + 1)])
##                 wgt.matrix[lg, lg:na] &lt;- delta_w[lg, 1:(na - 
##                   lg + 1)]
##             }
##             else {
##                 growth.matrix[lg, lg:(n + lg)] &lt;- delta_l[lg, 
##                   ]
##                 wgt.matrix[lg, lg:(n + lg)] &lt;- delta_w[lg, ]
##             }
##         }
##         growth.matrix &lt;- growth.matrix * as.vector(input_num)
##         wgt.matrix &lt;- growth.matrix * (wgt.matrix + as.vector(input_wgt))
##         return(array(c(Matrix::colSums(growth.matrix), Matrix::colSums(wgt.matrix)/logspace_add_vec(Matrix::colSums(growth.matrix), 
##             0)), dim = c(na, 2)))
##     }
##     ling_imm__minage &lt;- 3L
##     ling_imm__maxage &lt;- 10L
##     ling_imm__areas &lt;- model_data$ling_imm__areas
##     ling_imm__growth_l &lt;- array(dim = c(0L, 0L), dimnames = NULL)
##     ling_imm__dl &lt;- model_data$ling_imm__dl
##     ling_imm__growth_w &lt;- array(dim = c(0L, 0L), dimnames = NULL)
##     ling_imm__prevtotal &lt;- 0
##     ling_imm__num &lt;- array(dim = c(length = 6L, area = 2L, age = 8L
##     ), dimnames = list(length = c("len0", "len10", "len20", "len30", 
##     "len40", "len50"), area = c("area1", "area2"), age = c("age3", 
##     "age4", "age5", "age6", "age7", "age8", "age9", "age10")))
##     ling_imm__wgt &lt;- array(dim = c(length = 6L, area = 2L, age = 8L
##     ), dimnames = list(length = c("len0", "len10", "len20", "len30", 
##     "len40", "len50"), area = c("area1", "area2"), age = c("age3", 
##     "age4", "age5", "age6", "age7", "age8", "age9", "age10")))
##     while (TRUE) {
##         {
##             comment("g3a_grow for ling_imm")
##             for (age in seq(ling_imm__minage, ling_imm__maxage, 
##                 by = 1)) {
##                 ling_imm__age_idx &lt;- age - ling_imm__minage + 
##                   1
##                 for (ling_imm__area_idx in seq_along(ling_imm__areas)) {
##                   area &lt;- ling_imm__areas[[ling_imm__area_idx]]
##                   if (TRUE) {
##                     comment("Calculate length/weight delta matrices for current lengthgroups")
##                     ling_imm__growth_l &lt;- growth_bbinom(age * 
##                       10, ling_imm__dl, 4, param[["ling.bbin"]])
##                     ling_imm__growth_w &lt;- area * 20
##                     {
##                     }
##                     if (FALSE) 
##                       ling_imm__prevtotal &lt;- sum(ling_imm__num[, 
##                         ling_imm__area_idx, ling_imm__age_idx])
##                     comment("Update ling_imm using delta matrices")
##                     {
##                       growthresult &lt;- g3a_grow_apply(ling_imm__growth_l, 
##                         ling_imm__growth_w, ling_imm__num[, ling_imm__area_idx, 
##                           ling_imm__age_idx], ling_imm__wgt[, 
##                           ling_imm__area_idx, ling_imm__age_idx])
##                       {
##                         ling_imm__num[, ling_imm__area_idx, ling_imm__age_idx] &lt;- growthresult[, 
##                           (1)]
##                         ling_imm__wgt[, ling_imm__area_idx, ling_imm__age_idx] &lt;- growthresult[, 
##                           (2)]
##                       }
##                     }
##                     if (FALSE) 
##                       stopifnot(ling_imm__prevtotal - sum(ling_imm__num[, 
##                         ling_imm__area_idx, ling_imm__age_idx]) &lt; 
##                         1e-04)
##                   }
##                 }
##             }
##         }
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"
## attr(,"parameter_template")
## attr(,"parameter_template")$ling.bbin
## [1] NA</code></pre>
<p>…you can see our provided formula have been used to calculate <code>ling_imm__growth_l</code> and <code>ling_imm__growth_w</code>, and <code>age</code> and <code>area</code> are available to us thanks to the loops provided by the stock.</p>
</div>
<div id="model-parameterization" class="section level2">
<h2 class="hasAnchor">
<a href="#model-parameterization" class="anchor"></a>Model parameterization</h2>
<p>In the <code>g3a_growmature</code> function above, we see a reference to <code><a href="../reference/language.html">g3_param("ling.bbin")</a></code>. The <code><a href="../reference/language.html">g3_param()</a></code> function is pseudo-code that specifies the model should accept a parameter at this point. In the R code, this has been converted to <code>param[["ling.bbin"]]</code>, so when we call our R function, we can provide a value, e.g. <code>fn(list(ling.bbin = 6))</code>. We can also use <code><a href="../reference/language.html">g3_param_vector()</a></code> to provide a model with a vector of values. See <code><a href="../reference/language.html">?g3_param</a></code> for more information on this and other functions available to you.</p>
<p>When converting to TMB, there are a lot more options for using the optimisation features it offers.</p>
</div>
<div id="combining-actions" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-actions" class="anchor"></a>Combining actions</h2>
<p>Any useful model will have multiple actions, so the outputs from the <code>g3a_</code> functions need to be combined. To do this, you can pass a list of actions to any of the <code>g3_to_*</code> functions, for example:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">ling_model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_r.html">g3_to_r</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb26-2" title="2">    <span class="kw"><a href="../reference/action_age.html">g3a_age</a></span>(ling_imm),</a>
<a class="sourceLine" id="cb26-3" title="3">    <span class="kw"><a href="../reference/action_grow.html">g3a_growmature</a></span>(</a>
<a class="sourceLine" id="cb26-4" title="4">        ling_imm,</a>
<a class="sourceLine" id="cb26-5" title="5">        <span class="dt">impl_f =</span> <span class="kw"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span>(</a>
<a class="sourceLine" id="cb26-6" title="6">            <span class="dt">delta_len_f =</span> <span class="op">~</span>age <span class="op">*</span><span class="st"> </span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb26-7" title="7">            <span class="dt">delta_wgt_f =</span> <span class="op">~</span>area <span class="op">*</span><span class="st"> </span><span class="dv">20</span>,</a>
<a class="sourceLine" id="cb26-8" title="8">            <span class="dt">beta_f =</span> <span class="op">~</span><span class="kw"><a href="../reference/language.html">g3_param</a></span>(<span class="st">"ling.bbin"</span>),</a>
<a class="sourceLine" id="cb26-9" title="9">            <span class="dt">maxlengthgroupgrowth =</span> <span class="dv">4</span>)),</a>
<a class="sourceLine" id="cb26-10" title="10">    <span class="kw"><a href="../reference/action_time.html">g3a_time</a></span>(<span class="dv">1990</span>, <span class="dv">1999</span>)))</a></code></pre></div>
<p>A useful technique is to break down the actions into separate lists, e.g.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">ling_imm_actions &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb27-2" title="2">    <span class="kw"><a href="../reference/action_age.html">g3a_age</a></span>(ling_imm),</a>
<a class="sourceLine" id="cb27-3" title="3">    <span class="kw"><a href="../reference/action_grow.html">g3a_growmature</a></span>(</a>
<a class="sourceLine" id="cb27-4" title="4">        ling_imm,</a>
<a class="sourceLine" id="cb27-5" title="5">        <span class="dt">impl_f =</span> <span class="kw"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span>(</a>
<a class="sourceLine" id="cb27-6" title="6">            <span class="dt">delta_len_f =</span> <span class="op">~</span>age <span class="op">*</span><span class="st"> </span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb27-7" title="7">            <span class="dt">delta_wgt_f =</span> <span class="op">~</span>area <span class="op">*</span><span class="st"> </span><span class="dv">20</span>,</a>
<a class="sourceLine" id="cb27-8" title="8">            <span class="dt">beta_f =</span> <span class="op">~</span><span class="kw"><a href="../reference/language.html">g3_param</a></span>(<span class="st">"ling.bbin"</span>),</a>
<a class="sourceLine" id="cb27-9" title="9">            <span class="dt">maxlengthgroupgrowth =</span> <span class="dv">4</span>)))</a>
<a class="sourceLine" id="cb27-10" title="10">time_actions &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb27-11" title="11">    <span class="kw"><a href="../reference/action_time.html">g3a_time</a></span>(<span class="dv">1990</span>, <span class="dv">1999</span>))</a>
<a class="sourceLine" id="cb27-12" title="12"></a>
<a class="sourceLine" id="cb27-13" title="13">ling_model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_r.html">g3_to_r</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(ling_imm_actions, time_actions))</a></code></pre></div>
<p>We do not need to worry about the order the actions are provided in, since they will be re-ordered according to the <a href="http://hafro.github.io/gadget2/userguide/chap-order.html">gadget2 order of calculations</a>.</p>
<p>This works as all formula within actions are named:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(ling_imm_actions, names)</a></code></pre></div>
<pre><code>## [1] "012:001:ling_imm            "                  "005:ling_imm            :8b833ffffd80d7ba2342"</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(time_actions, names)</a></code></pre></div>
<pre><code>## [1] "000"</code></pre>
<p>…when building a model, formula are ordered by name, resulting in the desired order of calculations. If needed, the ordering can be changed using the <code>run_at</code> parameter of any action.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-formula-or-the-tilde-operator">R formula, or the tilde operator</a></li>
      <li><a href="#actions">Actions</a></li>
      <li><a href="#stocks">Stocks</a></li>
      <li><a href="#model-parameterization">Model parameterization</a></li>
      <li><a href="#combining-actions">Combining actions</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
