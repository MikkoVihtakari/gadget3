<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Structure of a gadget3 model • gadget3</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Structure of a gadget3 model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gadget3</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model_structure.html">Structure of a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/tmb-gotchas.html">Gotchas and quirks of TMB</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Structure of a gadget3 model</h1>
            
      
      
      <div class="hidden name"><code>model_structure.Rmd</code></div>

    </div>

    
    
<p>The following describes the structure of a gadget3 model, from the bottom up.</p>
<div id="r-formula-or-the-tilde-operator" class="section level2">
<h2 class="hasAnchor">
<a href="#r-formula-or-the-tilde-operator" class="anchor"></a>R formula, or the tilde operator</h2>
<p>Crucial to gadget3 is the <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/formula.html">R formula</a>, created using the tilde operator (<code>~</code>). These get used in several places in R for various things, but at their core the tilde operator stores the R code on the left and right hand sides, as well as the environment it was created in, which amounts to all variables defined at the time. For example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">get_formula &lt;-<span class="st"> </span><span class="cf">function</span> (size) {</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="co"># NB: Because this is in a function, it gets it's own environment</span></a>
<a class="sourceLine" id="cb1-3" title="3">    cows &lt;-<span class="st"> </span>size <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-4" title="4">    pigs &lt;-<span class="st"> </span>size <span class="op">*</span><span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="op">~</span>cows <span class="op">+</span><span class="st"> </span>pigs)</a>
<a class="sourceLine" id="cb1-6" title="6">}</a>
<a class="sourceLine" id="cb1-7" title="7">f &lt;-<span class="st"> </span><span class="kw">get_formula</span>(<span class="dv">8</span>)</a>
<a class="sourceLine" id="cb1-8" title="8">g &lt;-<span class="st"> </span><span class="kw">get_formula</span>(<span class="dv">5</span>)</a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(f)</a></code></pre></div>
<pre><code>## Class 'formula'  language ~cows + pigs
##   ..- attr(*, ".Environment")=&lt;environment: 0xnnnnnnnnnnnn&gt;</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(f[[<span class="dv">2</span>]])</a></code></pre></div>
<pre><code>##  language cows + pigs</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(f)))</a></code></pre></div>
<pre><code>## List of 3
##  $ pigs: num 32
##  $ cows: num 16
##  $ size: num 8</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(g)))</a></code></pre></div>
<pre><code>## List of 3
##  $ pigs: num 20
##  $ cows: num 10
##  $ size: num 5</code></pre>
<p>Note that:</p>
<ul>
<li>R hasn’t at any point worked out <code>cows + pigs</code>, the code was stored for later use.</li>
<li>The environment (i.e. all variables defined at that point) is “remembered”</li>
</ul>
<p>A g3 model at it’s core is a list of formula. We can compile our simple example above into code:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">g3_compile_r</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(f))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     cows &lt;- 16
##     pigs &lt;- 32
##     while (TRUE) {
##         cows + pigs
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">g3_precompile_tmb</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(f))</a></code></pre></div>
<pre><code>## #include &lt;TMB.hpp&gt;
## #include &lt;stdio.h&gt;  // For debugf
## #include &lt;stdarg.h&gt;  // For debugf
## 
## template&lt;class Type&gt;
## Type objective_function&lt;Type&gt;::operator() () {
##     
##     Type cows = 16;
##     Type pigs = 32;
## 
##     while (true) {
##         cows + pigs;
##     }
##     abort();  // Should have returned somewhere in the loop
## }</code></pre>
<p>Obviously this in itself isn’t a very useful function, but you can see that the environment for the formula has provided the initial values for the variables, and the code itself has been put into the main loop.</p>
<p>Also note that, despite appearances, we’re not generically converting R into C++. There’s a subset of R that gadget3 understands and knows how to convert. Using R libraries isn’t possible, for example. To simplify scoping rules, we assume variables are either global, and should have different names, or are iterators in loops, in which case they will be local to that loop.</p>
</div>
<div id="actions" class="section level2">
<h2 class="hasAnchor">
<a href="#actions" class="anchor"></a>Actions</h2>
<p>In reality you will never be providing formulae to insert into models directly, you’d be using the g3 action functions to generate these for you. All action functions, prefixed with <code>g3a_</code>, produce a list of formula objects. One of the simplest is <code>g3a_time</code>, which produces code that will count years/steps, and stop when the end of the time period is reached. For example:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">g3a_time</span>(<span class="dv">1990</span>, <span class="dv">1999</span>)</a></code></pre></div>
<pre><code>## $`000`
## ~{
##     comment("g3a_time")
##     cur_time &lt;- cur_time + 1
##     if (cur_time &gt; total_steps) 
##         return(nll)
##     cur_year &lt;- start_year + (cur_time%/%step_count)
##     cur_step &lt;- (cur_time%%step_count) + 1
##     cur_step_len &lt;- steps[[g3_idx(cur_step)]]
##     cur_step_final &lt;- cur_step == step_count
##     debugf("** Tick: %d-%d\n", cur_year, cur_step)
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;</code></pre>
<p>Like in the example above, the definitions are part of the formula’s environment, and if we compile it we see our years ending up in the code.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">g3_compile_r</span>(<span class="kw">g3a_time</span>(<span class="dv">1990</span>, <span class="dv">1999</span>))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     debugf &lt;- function (...) 
##     {
##         cat(sprintf(...))
##     }
##     cur_time &lt;- -1L
##     steps &lt;- 12L
##     end_year &lt;- 1999L
##     start_year &lt;- 1990L
##     total_steps &lt;- length(steps) * (end_year - start_year) + 
##         length(steps) - 1
##     nll &lt;- 0
##     cur_year &lt;- 0L
##     step_count &lt;- 1L
##     cur_step &lt;- 0L
##     cur_step_len &lt;- 0L
##     cur_step_final &lt;- FALSE
##     while (TRUE) {
##         {
##             comment("g3a_time")
##             cur_time &lt;- cur_time + 1
##             if (cur_time &gt; total_steps) 
##                 return(nll)
##             cur_year &lt;- start_year + (cur_time%/%step_count)
##             cur_step &lt;- (cur_time%%step_count) + 1
##             cur_step_len &lt;- steps[[(cur_step)]]
##             cur_step_final &lt;- cur_step == step_count
##             debugf("** Tick: %d-%d\n", cur_year, cur_step)
##         }
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"</code></pre>
<p>In this case our years have been hard-coded, but their definitions could themselves be formula and the end result will be added to the model. For example:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">g3_compile_r</span>(<span class="kw">g3a_time</span>(<span class="dv">1990</span>, <span class="op">~</span>start_year <span class="op">+</span><span class="st"> </span><span class="dv">4</span> ))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     debugf &lt;- function (...) 
##     {
##         cat(sprintf(...))
##     }
##     cur_time &lt;- -1L
##     steps &lt;- 12L
##     start_year &lt;- 1990L
##     end_year &lt;- start_year + 4
##     total_steps &lt;- length(steps) * (end_year - start_year) + 
##         length(steps) - 1
##     nll &lt;- 0
##     cur_year &lt;- 0L
##     step_count &lt;- 1L
##     cur_step &lt;- 0L
##     cur_step_len &lt;- 0L
##     cur_step_final &lt;- FALSE
##     while (TRUE) {
##         {
##             comment("g3a_time")
##             cur_time &lt;- cur_time + 1
##             if (cur_time &gt; total_steps) 
##                 return(nll)
##             cur_year &lt;- start_year + (cur_time%/%step_count)
##             cur_step &lt;- (cur_time%%step_count) + 1
##             cur_step_len &lt;- steps[[(cur_step)]]
##             cur_step_final &lt;- cur_step == step_count
##             debugf("** Tick: %d-%d\n", cur_year, cur_step)
##         }
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"</code></pre>
<p>TODO: This example rapidly runs out of steam since we don’t substitute the formula’s environment into the output expression. Fix it or stop suggesting it.</p>
<div id="combining-actions" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-actions" class="anchor"></a>Combining actions</h3>
<p>Any useful model will have multiple actions, so the outputs from the <code>g3a_</code> functions need to be combined. Whilst the lists could be done with the standard R function <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>, we also need to make sure that:</p>
<ul>
<li>Steps within actions aren’t repeated</li>
<li>Actions need to be in an appropriate order, matching Gadget’s order of operations.</li>
</ul>
<p>To do this, use <code>g3_collate()</code>. For example:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">ling_model &lt;-<span class="st"> </span><span class="kw">g3_compile_r</span>(<span class="kw">g3_collate</span>(</a>
<a class="sourceLine" id="cb20-2" title="2">    <span class="kw">g3a_age</span>(ling_imm),</a>
<a class="sourceLine" id="cb20-3" title="3">    <span class="kw">g3a_age</span>(ling_mat),</a>
<a class="sourceLine" id="cb20-4" title="4">    <span class="kw">g3a_mature</span>(ling_imm, ling_mat, maturity_f),</a>
<a class="sourceLine" id="cb20-5" title="5">    time))</a></code></pre></div>
<p><code>g3_collate()</code> just orders actions by name, the actions themselves set the name based on the standard order of actions. This can be altered with the <code>run_at</code> parameter if required.</p>
</div>
</div>
<div id="stocks" class="section level2">
<h2 class="hasAnchor">
<a href="#stocks" class="anchor"></a>Stocks</h2>
<p>Many g3 actions require <em>stocks</em>, these represent data storage for anything within the operating model.</p>
<p>They can be created with either <code>g3_stock()</code> or <code>g3_fleet()</code>. The former will store number of individuals and their weight by length, the latter catch.</p>
<p>Stocks can be broken down further by applying either <code>g3s_livesonareas()</code> or <code>g3s_age()</code>, which adds area or age dimensions to a stock.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">areas &lt;-<span class="st"> </span><span class="kw">g3_areas</span>(<span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'c'</span>)</a>
<a class="sourceLine" id="cb21-2" title="2"></a>
<a class="sourceLine" id="cb21-3" title="3">ling_imm &lt;-<span class="st"> </span><span class="kw">g3_stock</span>(<span class="st">'ling_imm'</span>, <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">20</span>, <span class="dv">156</span>, <span class="dv">4</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">    </span><span class="kw">g3s_livesonareas</span>(areas[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'a'</span>)]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">    </span><span class="kw">g3s_age</span>(<span class="dv">3</span>, <span class="dv">10</span>)</a></code></pre></div>
<p>Variables that the stock uses within the model will be named based on the name given to <code>g3_stock()</code>, in the case above <code>ling_imm__num</code> and <code>ling_imm__wgt</code> will be defined.</p>
<p>When you use an action such as <code>g3a_grow()</code>, you provide formulae to fill in the gaps. These will iterate over any dimensions the stock has, such as age and area, and will be available to you when writing these formulae.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">g3_compile_r</span>(<span class="kw">g3a_grow</span>(</a>
<a class="sourceLine" id="cb22-2" title="2">    ling_imm,</a>
<a class="sourceLine" id="cb22-3" title="3">    <span class="dt">growth_f =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb22-4" title="4">        <span class="dt">len =</span> <span class="op">~</span>age <span class="op">*</span><span class="st"> </span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb22-5" title="5">        <span class="dt">wgt =</span> <span class="op">~</span>area <span class="op">*</span><span class="st"> </span><span class="dv">20</span>),</a>
<a class="sourceLine" id="cb22-6" title="6">    <span class="dt">impl_f =</span> <span class="kw">g3a_grow_impl_bbinom</span>(</a>
<a class="sourceLine" id="cb22-7" title="7">        <span class="dt">beta_f =</span> <span class="op">~</span><span class="kw">g3_param</span>(<span class="st">"ling.bbin"</span>),</a>
<a class="sourceLine" id="cb22-8" title="8">        <span class="dt">maxlengthgroupgrowth =</span> <span class="dv">4</span>)))</a></code></pre></div>
<pre><code>## function (param) 
## {
##     growth_bbinom &lt;- function (dmu, lengthgrouplen, binn, beta) 
##     {
##         delt_l &lt;- dmu/lengthgrouplen
##         alpha &lt;- (beta * delt_l)/(binn - delt_l)
##         x &lt;- 0:binn
##         na &lt;- length(alpha)
##         n &lt;- length(x) - 1
##         alpha &lt;- rep(alpha, n + 1)
##         x &lt;- rep(x, each = na)
##         val &lt;- exp(lgamma(n + 1) + lgamma(alpha + beta) + lgamma(n - 
##             x + beta) + lgamma(x + alpha) - lgamma(n - x + 1) - 
##             lgamma(x + 1) - lgamma(n + alpha + beta) - lgamma(beta) - 
##             lgamma(alpha))
##         dim(val) &lt;- c(na, n + 1)
##         return(val)
##     }
##     g3a_grow_apply &lt;- function (lg_deltas, input_num) 
##     {
##         na &lt;- dim(lg_deltas)[[1]]
##         n &lt;- dim(lg_deltas)[[2]] - 1
##         growth.matrix &lt;- array(0, c(na, na))
##         for (lg in 1:na) {
##             if (lg == na) {
##                 growth.matrix[na, na] &lt;- 1
##             }
##             else if (lg + n &gt; na) {
##                 growth.matrix[lg, lg:(na - 1)] &lt;- lg_deltas[lg, 
##                   1:(na - lg)]
##                 growth.matrix[lg, na] &lt;- sum(lg_deltas[lg, (na - 
##                   lg + 1):(n + 1)])
##             }
##             else {
##                 growth.matrix[lg, lg:(n + lg)] &lt;- lg_deltas[lg, 
##                   ]
##             }
##         }
##         return(Matrix::colSums(growth.matrix * as.vector(input_num)))
##     }
##     ling_imm__minage &lt;- 3L
##     ling_imm__maxage &lt;- 10L
##     ling_imm__area &lt;- 1L
##     ling_imm__growth_l &lt;- array(dim = c(0L, 0L))
##     ling_imm__dl &lt;- model_data$ling_imm__dl
##     ling_imm__growth_w &lt;- array(dim = 35L)
##     ling_imm__wgt &lt;- array(dim = c(35L, 1L, 8L))
##     ling_imm__area_idx &lt;- (1)
##     ling_imm__num &lt;- array(dim = c(35L, 1L, 8L))
##     while (TRUE) {
##         {
##             comment("g3a_grow for ling_imm")
##             for (age in seq(ling_imm__minage, ling_imm__maxage)) {
##                 ling_imm__age_idx &lt;- age - ling_imm__minage + 
##                   1
##                 {
##                   area &lt;- ling_imm__area
##                   {
##                     comment("Calculate increase in length/weight for each lengthgroup")
##                     ling_imm__growth_l &lt;- growth_bbinom(age * 
##                       10, ling_imm__dl, length(ling_imm__dl), 
##                       param[["ling.bbin"]])
##                     ling_imm__growth_w &lt;- area * 20
##                     ling_imm__wgt[, ling_imm__area_idx, ling_imm__age_idx] &lt;- ling_imm__wgt[, 
##                       ling_imm__area_idx, ling_imm__age_idx] * 
##                       ling_imm__num[, ling_imm__area_idx, ling_imm__age_idx]
##                     ling_imm__num[, ling_imm__area_idx, ling_imm__age_idx] &lt;- g3a_grow_apply(ling_imm__growth_l, 
##                       ling_imm__num[, ling_imm__area_idx, ling_imm__age_idx])
##                     ling_imm__wgt[, ling_imm__area_idx, ling_imm__age_idx] &lt;- (ling_imm__wgt[, 
##                       ling_imm__area_idx, ling_imm__age_idx] + 
##                       ling_imm__growth_w)/pmax(ling_imm__num[, 
##                       ling_imm__area_idx, ling_imm__age_idx], 
##                       1e-05)
##                   }
##                 }
##             }
##         }
##     }
##     stop("Should have return()ed somewhere in the loop")
## }
## &lt;environment: 0xnnnnnnnnnnnn&gt;
## attr(,"class")
## [1] "g3_r"     "function"</code></pre>
<p>…you can see our provided formula have been used to calculate <code>ling_imm__growth_l</code> and <code>ling_imm__growth_w</code>, and <code>age</code> and <code>area</code> are available to us thanks to the loops provided by the stock.</p>
</div>
<div id="advanced-topics" class="section level2">
<h2 class="hasAnchor">
<a href="#advanced-topics" class="anchor"></a>Advanced topics</h2>
<p>Beyond this point, we mostly discuss features that are only relevant to devloping gadget3.</p>
<p>TODO: Most of this is internal to gadget3, I’m not sure when/if it should be exposed and allow others to have at it.</p>
</div>
<div id="g3-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#g3-functions" class="anchor"></a>g3 Functions</h2>
<p>There are also special g3 functions that can be used in formula that affect the resulting code, rather than just being called when run.</p>
<dl>
<dt>g3_idx(i)</dt>
<dd>
<p>Arrays in R are 1-based, TMB arrays are 0-based. To avoid off-by-one errors, any variable that gets used as an array index should be converted by <code>g3_idx()</code>, for example: <code>steps[[g3_idx(cur_step)]]</code>. Making this explicit results in cleaner output code.</p>
</dd>
<dt>g3_param(n) / g3_param_array(n) / g3_param_matrix(n) / g3_param_vector(n)</dt>
<dd>
<p>Defines a parameter with a given name n to be used in the model, e.g. <code>g3_param("linf")</code>.</p>
</dd>
</dl>
<p>Under TMB produces an equivalent <code>PARAMETER(n)</code> definition. Under R produces <code>param[["linf"]]</code>, where param is the single argument to the function.</p>
<dl>
<dt>g3_report(var)</dt>
<dd>
<p>Appends the state of var to the report, e.g. <code>g3_report(cur_time)</code>.</p>
</dd>
</dl>
<p>Under TMB produces <code>REPORT(cur_time)</code>. See TMB docs for how to get the value.</p>
<p>Under R reported values can be got using <code>environment(model_fn)$model_report</code>.</p>
<dl>
<dt>g3_with(var, expr, code)</dt>
<dd>
<p>We stated earlier that variables are either global or iterators in loops, sometimes it’s useful to define a variable in a local scope too, for example, we often define both <code>area</code> and <code>stock__area_idx</code> variables, where one is calculated using the other. We can use:</p>
<p>g3_with(area, stock__areas[stock__area_idx], {…} )</p>
</dd>
</dl>
<p>…to define <code>area</code> in a local scope too.</p>
</div>
<div id="stock-steps" class="section level2">
<h2 class="hasAnchor">
<a href="#stock-steps" class="anchor"></a>Stock steps</h2>
<p>Most actions interact with stocks, and fill out abstract formulae with the stocks provided to the function. To do this you need to do a series of substitutions, which are handled by <code>stock_step()</code>. This takes a formula, looks for <code>stock_*</code> named functions and mangles the formula as appropriate. For example, a snippet from <code>action_mature.R</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">    out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span>(<span class="dt">parent =</span> <span class="kw"><a href="https://rdrr.io/r/base/environment.html">emptyenv</a></span>())</a>
<a class="sourceLine" id="cb24-2" title="2">    out[[<span class="kw">step_id</span>(run_at, <span class="dv">1</span>, stock)]] &lt;-<span class="st"> </span><span class="kw">stock_step</span>(<span class="kw">f_substitute</span>(<span class="op">~</span>{</a>
<a class="sourceLine" id="cb24-3" title="3">        <span class="kw">stock_comment</span>(<span class="st">"g3a_mature for "</span>, stock)</a>
<a class="sourceLine" id="cb24-4" title="4">        <span class="co"># Matured stock will weigh the same</span></a>
<a class="sourceLine" id="cb24-5" title="5">        <span class="kw">stock_rename</span>(stock, <span class="kw">stock_rename</span>(matured, matured__wgt &lt;-<span class="st"> </span>stock__wgt))</a>
<a class="sourceLine" id="cb24-6" title="6"></a>
<a class="sourceLine" id="cb24-7" title="7">        <span class="kw">stock_iterate</span>(stock, <span class="kw">stock_intersect</span>(matured, <span class="cf">if</span> (run_f) {</a>
<a class="sourceLine" id="cb24-8" title="8">            <span class="kw">stock_comment</span>(<span class="st">"Move matured "</span>, stock, <span class="st">" into temporary storage"</span>)</a>
<a class="sourceLine" id="cb24-9" title="9">            matured__num[matured__iter] &lt;-<span class="st"> </span>stock__num[stock__iter] <span class="op">*</span><span class="st"> </span>maturity_f</a>
<a class="sourceLine" id="cb24-10" title="10">            stock__num[stock__iter] &lt;-<span class="st"> </span>stock__num[stock__iter] <span class="op">-</span><span class="st"> </span>matured__num[matured__iter]</a>
<a class="sourceLine" id="cb24-11" title="11">        }))</a>
<a class="sourceLine" id="cb24-12" title="12">    }, <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">run_f =</span> run_f, <span class="dt">maturity_f =</span> maturity_f)))</a></code></pre></div>
<p>Assume that <code>stock</code> has name “ling_imm” and <code>matured</code> has name “ling_imm_maturing”.</p>
<p>The first line uses <code>stock_comment()</code> to produce a <code><a href="https://rdrr.io/r/base/comment.html">comment()</a></code> function call, <code><a href="https://rdrr.io/r/base/comment.html">comment("g3a_mature for ling_imm")</a></code>.</p>
<p>Next <code>stock_rename()</code> is used to to transform <code>matured__wgt &lt;- stock__wgt</code> to use the proper stock names. We don’t care about dimensions since we’re copying over all the data.</p>
<p>Finally, we use a combination of <code>stock_iterate()</code> and <code>stock_intersect()</code>. <code>stock_iterate()</code> will create a loop that loops over all of the stock’s dimensions, and replace <code>[stock__iter]</code> with a subset that will provide a 1-dimension lengthgroup vector. <code>stock_intersect()</code>.</p>
<p>These iterators will then be available to the <code>maturity_f</code> that the users provide, as demonstrated in the <a href="#stocks">Stocks</a> section.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-formula-or-the-tilde-operator">R formula, or the tilde operator</a></li>
      <li><a href="#actions">Actions</a></li>
      <li><a href="#stocks">Stocks</a></li>
      <li><a href="#advanced-topics">Advanced topics</a></li>
      <li><a href="#g3-functions">g3 Functions</a></li>
      <li><a href="#stock-steps">Stock steps</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
