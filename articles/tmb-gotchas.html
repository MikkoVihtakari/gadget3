<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gotchas and quirks of TMB • gadget3</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Gotchas and quirks of TMB">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gadget3</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model_structure.html">Structure of a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/tmb-gotchas.html">Gotchas and quirks of TMB</a>
    </li>
    <li>
      <a href="../articles/writing_actions.html">Writing G3 Actions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Gotchas and quirks of TMB</h1>
            
      
      
      <div class="hidden name"><code>tmb-gotchas.Rmd</code></div>

    </div>

    
    
<p>A grab-bag of things to be aware of when writing code that will get used in TMB.</p>
<div id="links-that-are-useful-when-getting-to-grips-with-tmb" class="section level2">
<h2 class="hasAnchor">
<a href="#links-that-are-useful-when-getting-to-grips-with-tmb" class="anchor"></a>Links that are useful when getting to grips with TMB:</h2>
<ul>
<li><a href="http://kaskr.github.io/adcomp/matrix_arrays_8cpp-example.html" class="uri">http://kaskr.github.io/adcomp/matrix_arrays_8cpp-example.html</a></li>
<li>
<a href="https://kaskr.github.io/adcomp/structtmbutils_1_1array.html" class="uri">https://kaskr.github.io/adcomp/structtmbutils_1_1array.html</a> - TMB defines it’s own array and vector classes. A vector isn’t just a 1 dimensional array, it’s got lots of extra methods.</li>
<li><a href="https://github.com/kaskr/adcomp/wiki/Code--snippets" class="uri">https://github.com/kaskr/adcomp/wiki/Code--snippets</a></li>
</ul>
</div>
<div id="arrays-are-one-dimensional-under-the-hood" class="section level2">
<h2 class="hasAnchor">
<a href="#arrays-are-one-dimensional-under-the-hood" class="anchor"></a>Arrays are one dimensional under the hood</h2>
<p>A <code>tmbutils::Array</code>, whilst based on an Eigen array, manages dimensions itself. As a result if you call any inherited Eigen methods, dimensions can disappear.</p>
<p>From <a href="https://kaskr.github.io/adcomp/structtmbutils_1_1array.html" class="uri">https://kaskr.github.io/adcomp/structtmbutils_1_1array.html</a>:</p>
<blockquote>
<p>Methods that are not documented here are inherited from the Eigen library and applied on the underlying n-by-1 array. In general this will yield surprising results for 2D specific array methods.</p>
</blockquote>
</div>
<div id="has-to-be-some-kind-of-return-value" class="section level2">
<h2 class="hasAnchor">
<a href="#has-to-be-some-kind-of-return-value" class="anchor"></a>Has to be some kind of return value</h2>
<p>The return value in a g3 model, ``nll’’, can’t just be a hard coded value, has to be e.g. a parameter There has to be at least 1 parameter, otherwise there will be an Eigen error on return.</p>
<p>Obviously not a huge practical problem, but easily crops up in unit tests.</p>
</div>
<div id="autofilling-vectors" class="section level2">
<h2 class="hasAnchor">
<a href="#autofilling-vectors" class="anchor"></a>Autofilling vectors</h2>
<p>Can’t do <code>vector = single_value</code>, have to use <code>vector.setConstant(single_value)</code>.</p>
<p>g3 will mostly handle this automatically, but seems like something that could be fixed in TMB.</p>
</div>
<div id="parameter-ordering" class="section level2">
<h2 class="hasAnchor">
<a href="#parameter-ordering" class="anchor"></a>Parameter ordering</h2>
<p>When parameters are provided to TMB, they are flattened into one big vector. As a result they need to be flattened in the expected order. When providing defaults TMB will do this for you, but when calling the model it expects it to be already done.</p>
<p>Also, in <code>?MakeADFun</code>:</p>
<pre><code>Do not rely upon the default arguments of any of the functions in
the model object ‘obj$fn’, ‘obj$gr’, ‘obj$he’, ‘obj$report’. I.e.
always use the explicit form ‘obj$fn(obj$par)’ rather than
‘obj$fn()’.</code></pre>
<p>The following seems to re-order in the expected way, but seems naff:</p>
<pre><code>params &lt;- list(... unordered params ...)
par &lt;- unlist(params[names(environment(model_cpp)$model_parameters)])</code></pre>
<p>We could abstract, but there’s probably a better solution.</p>
</div>
<div id="vectorize1_t-macros" class="section level2">
<h2 class="hasAnchor">
<a href="#vectorize1_t-macros" class="anchor"></a>VECTORIZE1_t macros</h2>
<p>The “R-like” functions TMB provides, such as <code><a href="https://rdrr.io/r/base/Special.html">lgamma()</a></code> are defined using the <code>VECTORIZE</code> macros. These macros expect a single symbol, and will produce mysterious errors if an expression is used.</p>
<p>Instead of <code><a href="https://rdrr.io/r/base/Special.html">lgamma(alpha + beta)</a></code>, do something like:</p>
<pre><code>lgamma_arg = alpha + beta; val_vec = val_vec + lgamma(lgamma_arg);</code></pre>
</div>
<div id="no-vector-to-vector-conversion" class="section level2">
<h2 class="hasAnchor">
<a href="#no-vector-to-vector-conversion" class="anchor"></a>No vector<int> to vector<type> conversion</type></int>
</h2>
<p>Can’t do <code>stock__num.col(...) = (integer vector)</code>, since this needs an explicit cast. This is problematic for e.g:</p>
<pre><code><a href="../reference/action_renewal.html">g3a_initialconditions(prey_a, ~10 * prey_a__minlen)</a></code></pre>
<p>This case is a somewhat artifical construct, and not a problem for midlen (which isn’t integer), a more likely scenario.</p>
<p>No easy solutions, since gadget3 doesn’t have enough type information and Eigen needs explicit casts.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#links-that-are-useful-when-getting-to-grips-with-tmb">Links that are useful when getting to grips with TMB:</a></li>
      <li><a href="#arrays-are-one-dimensional-under-the-hood">Arrays are one dimensional under the hood</a></li>
      <li><a href="#has-to-be-some-kind-of-return-value">Has to be some kind of return value</a></li>
      <li><a href="#autofilling-vectors">Autofilling vectors</a></li>
      <li><a href="#parameter-ordering">Parameter ordering</a></li>
      <li><a href="#vectorize1_t-macros">VECTORIZE1_t macros</a></li>
      <li><a href="#no-vector-to-vector-conversion">No vector<int> to vector<type> conversion</type></int></a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
